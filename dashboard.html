<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Member Dashboard</title>
<style>
body {
    margin:0;
    background:#000;
    color:#fff;
    font-family:Arial,sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    text-align:center;
}
.message { font-size:20px; }
</style>
</head>
<body>

<div class="message">Checking Membership...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCTQDlsZNhZ-I6CvlNgZDPgpJJYlYto6Rk",
  authDomain: "jalandhar-fitness-club.firebaseapp.com",
  projectId: "jalandhar-fitness-club",
  storageBucket: "jalandhar-fitness-club.firebasestorage.app",
  messagingSenderId: "899365845803",
  appId: "1:899365845803:web:a75a331462df8b017f236e"
};

initializeApp(firebaseConfig);
const auth = getAuth();

async function getMemberData(email) {
    const response = await fetch("https://docs.google.com/spreadsheets/d/1lXYKjtW2BzFEuIouRl04O8AT8zyiUaz3QwBHxsDwFqk/export?format=csv");
    const text = await response.text();

    const rows = text
        .split("\n")
        .map(r => r.trim())
        .filter(r => r !== "" && !r.toLowerCase().startsWith("email"));

    for (let row of rows) {
        const parts = row.split(",");
        const sheetEmail = parts[0];
        const program = parts[1];
        const expiry = parts[2];
        const status = parts[3];

        if(sheetEmail && sheetEmail.trim().toLowerCase() === email.trim().toLowerCase()) {
            return {
                program: program ? program.trim().toLowerCase() : "",
                expiry: expiry ? expiry.trim() : "",
                status: status ? status.trim().toLowerCase() : ""
            };
        }
    }
    return null;
}

onAuthStateChanged(auth, async (user)=>{
    if(!user){
        window.location.href="login.html";
        return;
    }

    const data = await getMemberData(user.email);

    if(!data){
        document.body.innerHTML = "<div class='message'>Pending Approval</div>";
        return;
    }

    if(data.status !== "active"){
        document.body.innerHTML = "<div class='message'>Subscription Required â€“ $2/Week</div>";
        return;
    }

    const today = new Date();
    const expiryDate = new Date(data.expiry);

    if(today > expiryDate){
        document.body.innerHTML = "<div class='message'>Membership Expired</div>";
        return;
    }

    if(data.program === "shred"){
        window.location.href="shred.html";

    } else if(data.program === "strength"){
        window.location.href="strength.html";

    } else if(data.program === "bikini"){
        window.location.href="bikini.html";

    } else if(data.program === "p4"){
        window.location.href="p4.html";

    } else if(data.program === "p5"){
        window.location.href="p5.html";

    } else {
        document.body.innerHTML = "<div class='message'>No Program Assigned</div>";
    }
});
</script>

</body>
</html>
